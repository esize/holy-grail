- name: Add neovim repository
  ansible.builtin.apt_repository:
    repo: 'ppa:neovim-ppa/stable'

- name: Install neovim
  ansible.builtin.apt:
    update_cache: yes
    pkg:
      - neovim

- name: Clone neovim config
  ansible.builtin.git:
    repo: 'https://github.com/esize/my.nvim.git'
    dest: /home/evan/.config/nvim
    clone: yes
    update: yes

- name: Own neovim directory
  ansible.builtin.file:
    path: /home/evan/.config/nvim
    owner: evan
    group: evan
    recurse: true

- name: Install c compiler
  ansible.builtin.apt:
    pkg:
      - build-essential

- stat:
    path: /home/evan/.nvm
  register: nvm_path

- name: Setup NVM
  become: yes
  become_flags: -i 
  become_user: evan 
  block:
    - name: Install nvm
      shell: >
        curl -o- https://raw.githubusercontent.com/creationix/nvm/master/install.sh | bash 
      args:
        executable: /bin/bash
        chdir: "$HOME"
        creates: "$HOME/.nvm/nvm.sh"

    - name: add {{extra_path}} to path
      lineinfile:
        dest: /etc/environment
        state: present
        backrefs: yes
        regexp: 'PATH=(["]*)((?!.*?"{{extra_path}}").*?)(["]*)$'
        line: 'PATH=\1\2:"{{extra_path}}"\3'
      vars:
        extra_path: "$HOME/.nvm/nvm.sh"


  when: nvm_path.stat.exists == false

- name: Install node version using NVM
  become: yes
  become_flags: -i 
  become_user: evan 
  block:
  - name: Install node versions using loop
    command: nvm install {{item}}
    args:
      executable: /bin/bash
      chdir: "$HOME"
      creates: "$HOME/.nvm/versions/node/v{{item}}"
    loop:
      - 22.14.0
  - name: Install TypeScript
    command: npm install -g typescript
    args:
      executable: /bin/bash
      chdir: "$HOME"

- name: Install Neovim plugins using Lazy.nvim
  shell: nvim --headless "+Lazy sync" +qa
  args:
    executable: /bin/bash
  changed_when: false